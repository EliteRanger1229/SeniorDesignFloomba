<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Person Detection Alert</title>
    <style>
      :root { --ok: #1b5e20; --warn: #b71c1c; --bg: #0f172a; --fg: #e2e8f0; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--fg); margin: 0; padding: 2rem; }
      .card { max-width: 720px; margin: 0 auto; background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 1.25rem 1.5rem; }
      h1 { font-size: 1.25rem; margin: 0 0 0.5rem; }
      .status { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.65rem; border-radius: 999px; font-weight: 600; }
      .status.ok { background: #113b19; color: #d1fae5; border: 1px solid #1f7a2a; }
      .status.alert { background: #3b1111; color: #fee2e2; border: 1px solid #7a1f1f; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; }
      .box { background: #0b1220; border: 1px solid #111827; border-radius: 8px; padding: 0.75rem; min-height: 80px; }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color: #93c5fd; }
      .muted { color: #9ca3af; }
      .log { max-height: 240px; overflow: auto; }
      .footer { margin-top: 1rem; font-size: 0.9rem; color: #9ca3af; }
      a { color: #93c5fd; }
      .kv { display: grid; grid-template-columns: 180px 1fr; gap: 0.25rem 0.5rem; font-size: 0.9rem; }
      .btn { background:#0b1220; color:#e2e8f0; border:1px solid #111827; border-radius:6px; padding:0.35rem 0.6rem; cursor:pointer; }
      details summary { cursor: pointer; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Person Detection Alerts</h1>
      <div id="status" class="status ok">Waiting for detections…</div>

      <div style="margin: 0.5rem 0 0.75rem; display:flex; align-items:center; gap:0.5rem;">
        <label for="filter" class="muted">Filter by drone</label>
        <select id="filter" style="background:#0b1220; color:#e2e8f0; border:1px solid #111827; border-radius:6px; padding:0.35rem 0.5rem;">
          <option value="">All</option>
        </select>
      </div>

      <div class="grid">
        <div class="box">
          <div class="muted">Last event (filtered)</div>
          <div id="last">—</div>
        </div>
        <div class="box">
          <div class="muted">Total alerts (filtered)</div>
          <div id="count">0</div>
        </div>
      </div>

      <div class="box log" style="margin-top:1rem">
        <div class="muted">Event log</div>
        <div id="log"></div>
      </div>

      <details class="box" style="margin-top:1rem" id="debugBox">
        <summary>Debug / Diagnostics</summary>
        <div class="kv" style="margin-top:0.5rem">
          <div class="muted">Page URL</div>
          <div id="dbg-url"></div>

          <div class="muted">SSE State</div>
          <div id="dbg-ready">—</div>

          <div class="muted">Connection</div>
          <div id="dbg-conn">—</div>

          <div class="muted">Reconnect Attempts</div>
          <div id="dbg-retry">0</div>

          <div class="muted">Last Event Age</div>
          <div id="dbg-age">—</div>

          <div class="muted">Last Error</div>
          <div id="dbg-err">—</div>
        </div>
        <div style="margin-top:0.75rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
          <button class="btn" id="btn-diag">Run Diagnostics</button>
          <button class="btn" id="btn-clear">Clear Log</button>
        </div>
        <div class="muted" style="margin-top:0.5rem">Diagnostics perform quick GET checks to <code>/</code> and <code>/events</code> (with a short timeout) and report HTTP status or errors.</div>
      </details>

      <div class="footer">
        Connected to <code>/events</code>. Keep this tab open to receive alerts.
      </div>
    </div>

    <audio id="beep">
      <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAgD4AAIA+AAABAAgAZGF0YQAAAAA=" type="audio/wav">
    </audio>

    <script>
      const statusEl = document.getElementById('status');
      const lastEl = document.getElementById('last');
      const countEl = document.getElementById('count');
      const logEl = document.getElementById('log');
      const beep = document.getElementById('beep');
      const filterEl = document.getElementById('filter');
      const dbgUrl = document.getElementById('dbg-url');
      const dbgReady = document.getElementById('dbg-ready');
      const dbgConn = document.getElementById('dbg-conn');
      const dbgRetry = document.getElementById('dbg-retry');
      const dbgErr = document.getElementById('dbg-err');
      const dbgAge = document.getElementById('dbg-age');
      const btnDiag = document.getElementById('btn-diag');
      const btnClear = document.getElementById('btn-clear');

      let count = 0;
      const drones = new Set();
      let lastEventTs = 0; // seconds since epoch
      let reconnects = 0;
      let lastErrorMsg = '';

      function readyStateText(n) { return n === 0 ? 'CONNECTING' : n === 1 ? 'OPEN' : n === 2 ? 'CLOSED' : String(n); }
      function fmtAge(sec) {
        if (!sec) return '—';
        const d = Math.max(0, Math.floor(Date.now()/1000 - sec));
        return d + 's ago';
      }
      function ensureDroneOption(id) {
        if (!id || drones.has(id)) return;
        drones.add(id);
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = id;
        filterEl.appendChild(opt);
      }

      function setStatusAlert(conf) {
        statusEl.className = 'status alert';
        statusEl.textContent = `Person detected (conf ${conf})`;
      }

      function setStatusOk() {
        statusEl.className = 'status ok';
        statusEl.textContent = 'Waiting for detections…';
      }

      function log(msg) {
        const div = document.createElement('div');
        div.textContent = msg;
        logEl.prepend(div);
        try { console.log('[UI]', msg); } catch {}
      }

      // Connect to SSE endpoint
      const es = new EventSource('/events');
      es.onopen = () => {
        setStatusOk();
        log('Connected');
        if (dbgConn) dbgConn.textContent = 'Connected';
        if (dbgReady) dbgReady.textContent = readyStateText(es.readyState);
      };
      es.onerror = () => {
        statusEl.className = 'status';
        statusEl.textContent = 'Disconnected — retrying…';
        reconnects += 1; if (dbgRetry) dbgRetry.textContent = String(reconnects);
        lastErrorMsg = 'SSE error (network/server). Auto-retrying.';
        if (dbgErr) dbgErr.textContent = lastErrorMsg;
        if (dbgConn) dbgConn.textContent = 'Disconnected (retrying)';
        if (dbgReady) dbgReady.textContent = readyStateText(es.readyState);
        log('SSE error — will retry');
      };
      es.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          if (data && data.type === 'person_detected') {
            lastEventTs = data.ts || Math.floor(Date.now()/1000);
            const droneId = data.drone_id || 'unknown';
            ensureDroneOption(droneId);
            const selected = filterEl.value;
            const ts = new Date((data.ts || Date.now()) * 1000);
            // Always log with drone id
            log(`[${ts.toLocaleTimeString()}] [drone:${droneId}] person_detected (conf ${data.confidence})`);
            // Apply filter to UI counters/status
            if (!selected || selected === droneId) {
              count += 1;
              setStatusAlert(data.confidence);
              countEl.textContent = String(count);
              lastEl.textContent = ts.toLocaleString();
              try { beep.currentTime = 0; beep.play().catch(()=>{}); } catch (e) {}
              clearTimeout(window.__okTimer);
              window.__okTimer = setTimeout(setStatusOk, 1500);
            }
          }
        } catch {}
      };

      // Reset counters when filter changes (keeps log intact)
      filterEl.addEventListener('change', () => {
        count = 0;
        countEl.textContent = '0';
        lastEl.textContent = '—';
        setStatusOk();
      });

      // Periodic UI diagnostics and helpers
      if (dbgUrl) dbgUrl.textContent = window.location.href;
      setInterval(() => { if (dbgAge) dbgAge.textContent = fmtAge(lastEventTs); if (dbgReady) dbgReady.textContent = readyStateText(es.readyState); }, 1000);

      // Diagnostics button: quick GETs with short timeouts
      btnDiag?.addEventListener('click', async () => {
        function timeout(ms) { const c = new AbortController(); setTimeout(()=>c.abort(), ms); return c; }
        try {
          const r = await fetch('/', { signal: timeout(3000).signal });
          log(`Diag: GET / -> ${r.status}`);
        } catch (e) { log(`Diag: GET / failed: ${e && e.name ? e.name : 'error'}`); }
        try {
          const r2 = await fetch('/events', { headers: { 'Accept':'text/event-stream' }, signal: timeout(3000).signal });
          log(`Diag: GET /events -> ${r2.status}`);
        } catch (e) { log(`Diag: GET /events failed: ${e && e.name ? e.name : 'error'}`); }
      });

      // Clear log button
      btnClear?.addEventListener('click', () => { logEl.innerHTML = ''; });

      // Auto-open debug when ?debug=1
      try {
        const u = new URL(window.location.href);
        if (u.searchParams.get('debug') === '1') {
          document.getElementById('debugBox').open = true;
        }
      } catch {}
    </script>
  </body>
  </html>
